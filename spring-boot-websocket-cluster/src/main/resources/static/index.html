<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∂ÑÏÇ∞ Ï±ÑÌåÖ - Spring Boot + Pekko Cluster</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #1e3a5f; color: #eee; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: #0d2137; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; color: #6dd5ed; }
        .cluster-info { font-size: 0.9rem; color: #0d2137; background: #6dd5ed; padding: 0.5rem 1rem; border-radius: 20px; }
        .container { flex: 1; display: flex; max-width: 1400px; margin: 0 auto; width: 100%; padding: 1rem; gap: 1rem; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #0d2137; border-radius: 10px; overflow: hidden; }
        .messages { flex: 1; padding: 1rem; overflow-y: auto; }
        .message { margin-bottom: 0.8rem; padding: 0.8rem; border-radius: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.chat { background: #2c5282; }
        .message.chat.mine { background: #6dd5ed; color: #0d2137; margin-left: 20%; }
        .message.system { background: #4a5568; text-align: center; font-style: italic; }
        .message .meta { font-size: 0.75rem; color: #a0aec0; margin-bottom: 0.3rem; display: flex; justify-content: space-between; }
        .message.chat.mine .meta { color: #2c5282; }
        .message .node { background: #1a365d; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.7rem; }
        .message.chat.mine .node { background: #bee3f8; }
        .message .content { word-break: break-word; }
        .input-area { display: flex; padding: 1rem; background: #2c5282; }
        .input-area input { flex: 1; padding: 0.8rem; border: none; border-radius: 5px 0 0 5px; background: #1e3a5f; color: #eee; font-size: 1rem; }
        .input-area button { padding: 0.8rem 1.5rem; border: none; background: #6dd5ed; color: #0d2137; cursor: pointer; border-radius: 0 5px 5px 0; font-size: 1rem; font-weight: bold; }
        .input-area button:hover { background: #90e0ef; }
        .sidebar { width: 280px; background: #0d2137; border-radius: 10px; padding: 1rem; }
        .sidebar h3 { color: #6dd5ed; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #2c5282; }
        .user-list { list-style: none; }
        .user-list li { padding: 0.5rem; margin-bottom: 0.3rem; background: #2c5282; border-radius: 5px; display: flex; justify-content: space-between; }
        .user-list .node-badge { font-size: 0.7rem; background: #4a5568; padding: 0.2rem 0.5rem; border-radius: 10px; }
        .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: #0d2137; padding: 2rem; border-radius: 10px; text-align: center; }
        .login-box h2 { color: #6dd5ed; margin-bottom: 1.5rem; }
        .login-box input { padding: 0.8rem; width: 250px; border: none; border-radius: 5px; margin-bottom: 1rem; font-size: 1rem; }
        .login-box button { padding: 0.8rem 2rem; border: none; background: #6dd5ed; color: #0d2137; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .login-box button:hover { background: #90e0ef; }
        .hidden { display: none !important; }
        .status { padding: 0.5rem 1rem; text-align: center; font-size: 0.9rem; }
        .status.connected { background: #48bb78; color: white; }
        .status.disconnected { background: #f56565; color: white; }
        .status.connecting { background: #ed8936; color: white; }
        .badge { background: #6dd5ed; color: #0d2137; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; margin-left: 0.5rem; }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>üåê Î∂ÑÏÇ∞ Ï±ÑÌåÖ Ï∞∏Ïó¨</h2>
            <p style="color: #a0aec0; margin-bottom: 1rem;">Spring Boot + Pekko Cluster</p>
            <input type="text" id="usernameInput" placeholder="ÏÇ¨Ïö©ÏûêÎ™Ö ÏûÖÎ†•" autofocus>
            <br>
            <button onclick="connect()">Ï∞∏Ïó¨ÌïòÍ∏∞</button>
        </div>
    </div>

    <div class="header">
        <h1>üçÉ Spring Boot Î∂ÑÏÇ∞ Ï±ÑÌåÖ</h1>
        <div id="clusterInfo" class="cluster-info">Î°úÎî© Ï§ë...</div>
    </div>

    <div id="connectionStatus" class="status connecting">Ïó∞Í≤∞ Ï§ë...</div>

    <div class="container">
        <div class="chat-area">
            <div id="messages" class="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." disabled>
                <button id="sendBtn" onclick="sendMessage()" disabled>Ï†ÑÏÜ°</button>
            </div>
        </div>
        <div class="sidebar">
            <h3>üë• Ï†ëÏÜçÏûê Î™©Î°ù</h3>
            <ul id="userList" class="user-list"></ul>
        </div>
    </div>

    <script>
        let ws = null;
        let username = '';

        document.getElementById('usernameInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') connect();
        });

        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        async function loadClusterInfo() {
            try {
                const res = await fetch('/api/cluster-info');
                const info = await res.json();
                document.getElementById('clusterInfo').textContent =
                    `ÎÖ∏Îìú: ${info.selfAddress} | ÏÉÅÌÉú: ${info.state}`;
            } catch (e) {
                console.error('ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®', e);
            }
        }

        function connect() {
            username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('ÏÇ¨Ïö©ÏûêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }

            document.getElementById('loginOverlay').classList.add('hidden');
            updateStatus('connecting', 'Ïó∞Í≤∞ Ï§ë...');

            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/chat?username=${encodeURIComponent(username)}`);

            ws.onopen = () => {
                updateStatus('connected', `Ïó∞Í≤∞Îê® - ${username}`);
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messageInput').focus();
                loadClusterInfo();
                loadUsers();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            ws.onclose = () => {
                updateStatus('disconnected', 'Ïó∞Í≤∞ ÎÅäÍπÄ');
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            };

            ws.onerror = (error) => {
                console.error('WebSocket Ïò§Î•ò:', error);
                updateStatus('disconnected', 'Ïó∞Í≤∞ Ïò§Î•ò');
            };
        }

        function handleMessage(data) {
            const messagesDiv = document.getElementById('messages');

            if (data.type === 'chat') {
                const isMine = data.username === username;
                const nodeShort = data.nodeAddress ? (data.nodeAddress.split('@')[1] || data.nodeAddress) : '';
                messagesDiv.innerHTML += `
                    <div class="message chat ${isMine ? 'mine' : ''}">
                        <div class="meta">
                            <span>${data.username}</span>
                            <span class="node">${nodeShort}</span>
                        </div>
                        <div class="content">${escapeHtml(data.message)}</div>
                    </div>
                `;
                loadUsers();
            } else if (data.type === 'system') {
                messagesDiv.innerHTML += `
                    <div class="message system">
                        <div class="content">${escapeHtml(data.message)}</div>
                    </div>
                `;
                loadUsers();
            } else if (data.type === 'connected') {
                console.log('Ïó∞Í≤∞Îê®:', data);
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'message', content: message }));
                input.value = '';
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                const userList = document.getElementById('userList');
                userList.innerHTML = users.map(u => {
                    const nodeShort = u.nodeAddress ? (u.nodeAddress.split('@')[1] || u.nodeAddress) : '';
                    const isMe = u.username === username ? ' (ÎÇò)' : '';
                    return `<li>${escapeHtml(u.username)}${isMe}<span class="node-badge">${nodeShort}</span></li>`;
                }).join('');
            } catch (e) {
                console.error('ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïã§Ìå®', e);
            }
        }

        function updateStatus(type, text) {
            const status = document.getElementById('connectionStatus');
            status.className = `status ${type}`;
            status.textContent = text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                loadUsers();
            }
        }, 5000);
    </script>
</body>
</html>
