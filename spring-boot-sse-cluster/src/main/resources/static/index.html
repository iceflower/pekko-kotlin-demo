<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶„ì‚° ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ - Spring Boot + Pekko Cluster</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #1e3a5f; color: #eee; min-height: 100vh; }
        .header { background: #0d2137; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; color: #6dd5ed; }
        .cluster-info { font-size: 0.9rem; color: #0d2137; background: #6dd5ed; padding: 0.5rem 1rem; border-radius: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; display: grid; grid-template-columns: 1fr 300px; gap: 1rem; }
        .main-panel { display: flex; flex-direction: column; gap: 1rem; }
        .card { background: #0d2137; border-radius: 10px; padding: 1rem; }
        .card h3 { color: #6dd5ed; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #2c5282; }
        .status { padding: 0.5rem 1rem; text-align: center; font-size: 0.9rem; border-radius: 5px; margin-bottom: 1rem; }
        .status.connected { background: #48bb78; }
        .status.disconnected { background: #f56565; }
        .status.connecting { background: #ed8936; }
        .events { max-height: 400px; overflow-y: auto; }
        .event { margin-bottom: 0.8rem; padding: 0.8rem; border-radius: 8px; background: #2c5282; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .event .meta { font-size: 0.75rem; color: #a0aec0; margin-bottom: 0.3rem; display: flex; justify-content: space-between; }
        .event .type { background: #6dd5ed; color: #0d2137; padding: 0.1rem 0.5rem; border-radius: 10px; font-weight: bold; }
        .event .node { background: #4a5568; padding: 0.1rem 0.4rem; border-radius: 10px; }
        .event .data { word-break: break-word; font-family: monospace; background: #1e3a5f; padding: 0.5rem; border-radius: 5px; margin-top: 0.5rem; }
        .publish-form { display: flex; flex-direction: column; gap: 0.5rem; }
        .publish-form input, .publish-form textarea { padding: 0.8rem; border: none; border-radius: 5px; background: #2c5282; color: #eee; font-size: 1rem; }
        .publish-form textarea { min-height: 80px; resize: vertical; }
        .publish-form button { padding: 0.8rem; border: none; background: #6dd5ed; color: #0d2137; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .publish-form button:hover { background: #90e0ef; }
        .stats { list-style: none; }
        .stats li { padding: 0.5rem; margin-bottom: 0.3rem; background: #2c5282; border-radius: 5px; display: flex; justify-content: space-between; }
        .subscribers { max-height: 200px; overflow-y: auto; }
        .subscriber { padding: 0.5rem; margin-bottom: 0.3rem; background: #2c5282; border-radius: 5px; font-size: 0.85rem; }
        .subscriber .node-badge { font-size: 0.7rem; background: #4a5568; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸƒ Spring Boot ë¶„ì‚° ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼</h1>
        <div id="clusterInfo" class="cluster-info">ë¡œë”© ì¤‘...</div>
    </div>

    <div id="connectionStatus" class="status connecting">ì—°ê²° ì¤‘...</div>

    <div class="container">
        <div class="main-panel">
            <div class="card">
                <h3>ğŸ“¤ ì´ë²¤íŠ¸ ë°œí–‰</h3>
                <div class="publish-form">
                    <input type="text" id="eventType" placeholder="ì´ë²¤íŠ¸ íƒ€ì… (ì˜ˆ: notification, alert)" value="notification">
                    <textarea id="eventData" placeholder='ì´ë²¤íŠ¸ ë°ì´í„° (JSON)'>{"message": "Hello from Spring Boot cluster!", "priority": "high"}</textarea>
                    <button onclick="publishEvent()">ì´ë²¤íŠ¸ ë°œí–‰</button>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“¥ ìˆ˜ì‹ ëœ ì´ë²¤íŠ¸</h3>
                <div id="events" class="events"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <h3>ğŸ“Š í´ëŸ¬ìŠ¤í„° í†µê³„</h3>
                <ul id="stats" class="stats">
                    <li>ë¡œë”© ì¤‘...</li>
                </ul>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h3>ğŸ‘¥ êµ¬ë…ì</h3>
                <div id="subscribers" class="subscribers"></div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        function connect() {
            updateStatus('connecting', 'ì—°ê²° ì¤‘...');

            eventSource = new EventSource('/events/stream');

            eventSource.onopen = () => {
                updateStatus('connected', 'SSE ì—°ê²°ë¨');
                loadClusterInfo();
                loadStats();
            };

            eventSource.onmessage = (event) => {
                handleEvent('message', event);
            };

            eventSource.addEventListener('connected', (event) => {
                handleEvent('connected', event);
            });

            eventSource.addEventListener('notification', (event) => {
                handleEvent('notification', event);
            });

            eventSource.addEventListener('alert', (event) => {
                handleEvent('alert', event);
            });

            eventSource.onerror = () => {
                updateStatus('disconnected', 'SSE ì—°ê²° ëŠê¹€');
                setTimeout(connect, 3000);
            };
        }

        function handleEvent(eventType, event) {
            const data = JSON.parse(event.data);
            const eventsDiv = document.getElementById('events');
            const nodeShort = data.nodeAddress ? (data.nodeAddress.split('@')[1] || data.nodeAddress) : 'unknown';
            const time = new Date(data.timestamp || Date.now()).toLocaleTimeString();

            eventsDiv.innerHTML = `
                <div class="event">
                    <div class="meta">
                        <span class="type">${eventType}</span>
                        <span class="node">${nodeShort}</span>
                        <span>${time}</span>
                    </div>
                    <div class="data">${JSON.stringify(JSON.parse(data.data || '{}'), null, 2)}</div>
                </div>
            ` + eventsDiv.innerHTML;

            const events = eventsDiv.querySelectorAll('.event');
            if (events.length > 50) {
                events[events.length - 1].remove();
            }

            loadStats();
        }

        async function publishEvent() {
            const type = document.getElementById('eventType').value.trim() || 'message';
            const data = document.getElementById('eventData').value.trim() || '{}';

            try {
                const res = await fetch('/events/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, data })
                });
                if (res.ok) {
                    console.log('ì´ë²¤íŠ¸ ë°œí–‰ ì„±ê³µ');
                }
            } catch (e) {
                console.error('ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨', e);
            }
        }

        async function loadClusterInfo() {
            try {
                const res = await fetch('/api/cluster-info');
                const info = await res.json();
                document.getElementById('clusterInfo').textContent =
                    `ë…¸ë“œ: ${info.selfAddress} | ìƒíƒœ: ${info.state}`;
            } catch (e) {
                console.error('í´ëŸ¬ìŠ¤í„° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        async function loadStats() {
            try {
                const [statsRes, subscribersRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/subscribers')
                ]);
                const stats = await statsRes.json();
                const subscribers = await subscribersRes.json();

                document.getElementById('stats').innerHTML = `
                    <li>ë¡œì»¬ êµ¬ë…ì <span>${stats.localSubscribers}</span></li>
                    <li>ì´ êµ¬ë…ì <span>${stats.totalSubscribers}</span></li>
                    <li>ë…¸ë“œ <span>${stats.nodeAddress.split('@')[1] || stats.nodeAddress}</span></li>
                `;

                document.getElementById('subscribers').innerHTML = subscribers.map(s => {
                    const nodeShort = s.nodeAddress.split('@')[1] || s.nodeAddress;
                    return `<div class="subscriber">${s.id.substring(0, 8)}...<span class="node-badge">${nodeShort}</span></div>`;
                }).join('') || '<div class="subscriber">êµ¬ë…ì ì—†ìŒ</div>';
            } catch (e) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        function updateStatus(type, text) {
            const status = document.getElementById('connectionStatus');
            status.className = `status ${type}`;
            status.textContent = text;
        }

        setInterval(loadStats, 5000);
        connect();
    </script>
</body>
</html>
